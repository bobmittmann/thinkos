#include <fixpt.h>

#define SIN_N 64
#define LOG2_N 6
#define MASK_N 63

const int32_t sintab[] = {
	0x00000000, /*   0 - θ =  0.000000*π */
	0x0647d97c, /*   1 - θ =  0.015625*π */
	0x0c8bd35d, /*   2 - θ =  0.031250*π */
	0x12c8106e, /*   3 - θ =  0.046875*π */
	0x18f8b83c, /*   4 - θ =  0.062500*π */
	0x1f19f97a, /*   5 - θ =  0.078125*π */
	0x25280c5d, /*   6 - θ =  0.093750*π */
	0x2b1f34eb, /*   7 - θ =  0.109375*π */
	0x30fbc54c, /*   8 - θ =  0.125000*π */
	0x36ba2013, /*   9 - θ =  0.140625*π */
	0x3c56ba6f, /*  10 - θ =  0.156250*π */
	0x41ce1e64, /*  11 - θ =  0.171875*π */
	0x471cece6, /*  12 - θ =  0.187500*π */
	0x4c3fdff2, /*  13 - θ =  0.203125*π */
	0x5133cc93, /*  14 - θ =  0.218750*π */
	0x55f5a4d1, /*  15 - θ =  0.234375*π */
	0x5a827999, /*  16 - θ =  0.250000*π */
	0x5ed77c88, /*  17 - θ =  0.265625*π */
	0x62f201ab, /*  18 - θ =  0.281250*π */
	0x66cf811f, /*  19 - θ =  0.296875*π */
	0x6a6d98a3, /*  20 - θ =  0.312500*π */
	0x6dca0d13, /*  21 - θ =  0.328125*π */
	0x70e2cbc5, /*  22 - θ =  0.343750*π */
	0x73b5ebd0, /*  23 - θ =  0.359375*π */
	0x7641af3b, /*  24 - θ =  0.375000*π */
	0x78848412, /*  25 - θ =  0.390625*π */
	0x7a7d055a, /*  26 - θ =  0.406250*π */
	0x7c29fbed, /*  27 - θ =  0.421875*π */
	0x7d8a5f3e, /*  28 - θ =  0.437500*π */
	0x7e9d55fb, /*  29 - θ =  0.453125*π */
	0x7f62368e, /*  30 - θ =  0.468750*π */
	0x7fd8878c, /*  31 - θ =  0.484375*π */
	0x7fffffff, /*  32 - θ =  0.500000*π */
	0x7fd8878c, /*  33 - θ =  0.515625*π */
	0x7f62368e, /*  34 - θ =  0.531250*π */
	0x7e9d55fb, /*  35 - θ =  0.546875*π */
	0x7d8a5f3e, /*  36 - θ =  0.562500*π */
	0x7c29fbed, /*  37 - θ =  0.578125*π */
	0x7a7d055a, /*  38 - θ =  0.593750*π */
	0x78848412, /*  39 - θ =  0.609375*π */
	0x7641af3b, /*  40 - θ =  0.625000*π */
	0x73b5ebd0, /*  41 - θ =  0.640625*π */
	0x70e2cbc5, /*  42 - θ =  0.656250*π */
	0x6dca0d13, /*  43 - θ =  0.671875*π */
	0x6a6d98a3, /*  44 - θ =  0.687500*π */
	0x66cf811f, /*  45 - θ =  0.703125*π */
	0x62f201ab, /*  46 - θ =  0.718750*π */
	0x5ed77c88, /*  47 - θ =  0.734375*π */
	0x5a827999, /*  48 - θ =  0.750000*π */
	0x55f5a4d1, /*  49 - θ =  0.765625*π */
	0x5133cc93, /*  50 - θ =  0.781250*π */
	0x4c3fdff2, /*  51 - θ =  0.796875*π */
	0x471cece6, /*  52 - θ =  0.812500*π */
	0x41ce1e64, /*  53 - θ =  0.828125*π */
	0x3c56ba6f, /*  54 - θ =  0.843750*π */
	0x36ba2013, /*  55 - θ =  0.859375*π */
	0x30fbc54c, /*  56 - θ =  0.875000*π */
	0x2b1f34eb, /*  57 - θ =  0.890625*π */
	0x25280c5d, /*  58 - θ =  0.906250*π */
	0x1f19f97a, /*  59 - θ =  0.921875*π */
	0x18f8b83c, /*  60 - θ =  0.937500*π */
	0x12c8106e, /*  61 - θ =  0.953125*π */
	0x0c8bd35d, /*  62 - θ =  0.968750*π */
	0x0647d97c, /*  63 - θ =  0.984375*π */
};

int32_t q31sin(int32_t x)
{
	int32_t y321;
	int32_t y32;
	int32_t y21;
	int32_t y3;
	int32_t y2;
	int32_t y1;
	int32_t y;
	int32_t x3;
	int32_t x2;
	int32_t x1;
	int32_t dx;
	int32_t qx1;
	int32_t dx2;
	int64_t acc;
	int32_t sig;
	int i;

	dx = 1 << (31 - LOG2_N);
	i = x >> (31 - LOG2_N);

	x1 = i << (31 - LOG2_N);
	sig = (x1 < 0) ? -1 : 1;
	y1 = sintab[i++ & MASK_N] * sig;

	x2 = x1 + dx;
	sig = (x2 < 0) ? -1 : 1;
	y2 = sintab[i++ & MASK_N] * sig;

	x3 = x2 + dx;
	sig = (x3 < 0) ? -1 : 1;
	y3 = sintab[i & MASK_N] * sig;

	y21 = (y2 - y1);
	y32 = (y3 - y2);
	y321 = (y32 - y21) / 2;
	dx1 = Q31_DIV(x - x1, dx);
	dx2 = Q31_DIV(x - x2, dx);

	(void)dx2;
	(void)y321;

	acc = y1 + Q31_MUL(y21, qx1);
/* 	acc += Q31_MUL(y321, Q31_MUL(qx1, dx2)); */
	y = Q31_SAT(acc);

	return y;
}
